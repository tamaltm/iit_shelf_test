# Enhanced Notification System

## Overview
Comprehensive notification system for all library events with automated reminders and real-time alerts.

## Notification Types

### For Students/Teachers/Directors

1. **BorrowRequestApproved** ✅
   - Triggered: When librarian approves borrow request
   - Message: "Your borrow request for '[Book Title]' has been approved. Please collect it within 24 hours."
   - Location: `backend/api/lib/notification_helpers.php`

2. **DueDateReminder** ✅
   - Triggered: 2 days before due date (automated daily at 8 AM)
   - Message: "Reminder: Your borrowed book '[Book Title]' is due in 2 days ([Date]). Please return it to avoid late fees."
   - Location: MySQL Event `send_due_date_reminders`

3. **DueDateToday** ✅ NEW
   - Triggered: On the due date (automated daily at 7 AM)
   - Message: "Your borrowed book '[Book Title]' is due TODAY ([Date]). Please return it to avoid late fees."
   - Location: MySQL Event `send_due_date_today_reminders`

4. **ReservedBookAvailable** ✅
   - Triggered: When reserved book becomes available
   - Message: "Good news! '[Book Title]' is now available. Please collect it within [time] to maintain your reservation."
   - Location: `backend/api/lib/notification_helpers.php`

5. **ReservationMissed** ✅ NEW
   - Triggered: When user misses reservation pickup window (checked every 6 hours)
   - Message: "You missed your reservation pickup window for '[Book Title]'. The book is now available for others."
   - Location: MySQL Event `check_reservation_expiry`

6. **PaymentConfirmation** ✅
   - Triggered: After successful payment
   - Message: "Payment of [Amount] TK received successfully via [Method]. Your fines have been cleared."
   - Location: `backend/api/payments/process_payment.php`

7. **AdditionRequestApproved** ✅
   - Triggered: When librarian approves book addition request
   - Message: "Your book addition request for '[Book Title]' has been approved and added to the collection."
   - Location: `backend/api/lib/notification_helpers.php`

8. **FineLimitReached** ✅ NEW
   - Triggered: When unpaid fines exceed 200 TK (checked daily at 6 AM)
   - Message: "Your total unpaid fines ([Amount] TK) have exceeded the limit. Please pay your fines to continue borrowing books."
   - Location: MySQL Event `check_fine_limits`
   - Also checked at borrow request approval

### For Librarians

1. **BorrowRequestPending** ✅ NEW
   - Triggered: When user submits new borrow request
   - Message: "New borrow request from [User Email] for '[Book Title]' (Request #[ID])"
   - Location: `backend/api/borrow/request_borrow.php`

2. **ReturnRequestPending** ✅ NEW
   - Triggered: When user submits return request
   - Message: "New return request from [User Email] for '[Book Title]' (Transaction #[ID])"
   - Location: `backend/api/borrow/request_return.php`

3. **BookAdded** ✅ NEW
   - Triggered: When new book is added to collection
   - Message: "New book '[Book Title]' has been added to the collection by [User]"
   - Usage: Call `notifyLibrarianBookAdded($db, $bookTitle, $addedBy)` after book creation

4. **InventoryUpdate** ✅ NEW
   - Triggered: When inventory is updated
   - Message: "Inventory update: [Action] [Count] books on Shelf #[Number]"
   - Usage: Call `notifyLibrarianInventoryUpdate($db, $shelfNumber, $action, $count)`

5. **UserTransaction** ✅ NEW
   - Triggered: When user completes transaction
   - Message: "User [Email] completed [Type] for '[Book Title]'"
   - Usage: Call `notifyLibrarianUserTransaction($db, $userEmail, $transactionType, $bookTitle)`

6. **ReportGenerated** ✅ NEW
   - Triggered: When report is generated
   - Message: "Report '[Type]' has been generated by [User]"
   - Usage: Call `notifyLibrarianReportGenerated($db, $reportType, $generatedBy)`

## Database Schema

### Notifications Table
```sql
CREATE TABLE Notifications (
    notification_id INT PRIMARY KEY AUTO_INCREMENT,
    user_email VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    type ENUM(
        'BorrowRequestApproved',
        'BorrowRequestPending',
        'ReturnRequestApproved',
        'ReturnRequestPending',
        'ReservedBookAvailable',
        'ReservationQueueUpdate',
        'ReservationMissed',
        'DueDateReminder',
        'DueDateToday',
        'FineReminder',
        'FineLimitReached',
        'AdditionRequestApproved',
        'PaymentConfirmation',
        'BookAdded',
        'InventoryUpdate',
        'UserTransaction',
        'ReportGenerated',
        'System'
    ) DEFAULT 'System',
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_email (user_email),
    INDEX idx_sent_at (sent_at)
);
```

## Automated Events (MySQL)

### 1. send_due_date_reminders
- **Schedule**: Daily at 8:00 AM
- **Purpose**: Notify users 2 days before due date
- **Status**: ✅ ENABLED

### 2. send_due_date_today_reminders
- **Schedule**: Daily at 7:00 AM
- **Purpose**: Notify users on due date
- **Status**: ✅ ENABLED

### 3. send_fine_reminders
- **Schedule**: Every 3 days at 9:00 AM
- **Purpose**: Remind users about unpaid fines
- **Status**: ✅ ENABLED

### 4. check_reservation_expiry
- **Schedule**: Every 6 hours
- **Purpose**: Check for missed reservations and mark as expired
- **Status**: ✅ ENABLED

### 5. check_fine_limits
- **Schedule**: Daily at 6:00 AM
- **Purpose**: Notify users whose fines exceed 200 TK
- **Status**: ✅ ENABLED

### 6. cleanup_expired_borrow_requests
- **Schedule**: Every 1 hour
- **Purpose**: Remove expired borrow requests
- **Status**: ✅ ENABLED

### 7. cleanup_old_notifications
- **Schedule**: Monthly at 2:00 AM
- **Purpose**: Delete notifications older than 90 days
- **Status**: ✅ ENABLED

## Helper Functions

### File: `backend/api/lib/enhanced_notification_helpers.php`

All librarian notification functions:
- `notifyLibrarianBorrowRequest($db, $requesterEmail, $bookTitle, $requestId)`
- `notifyLibrarianReturnRequest($db, $requesterEmail, $bookTitle, $transactionId)`
- `notifyLibrarianBookAdded($db, $bookTitle, $addedBy)`
- `notifyLibrarianInventoryUpdate($db, $shelfNumber, $action, $count)`
- `notifyLibrarianUserTransaction($db, $userEmail, $transactionType, $bookTitle)`
- `notifyLibrarianReportGenerated($db, $reportType, $generatedBy)`
- `notifyFineLimitReached($db, $userEmail, $totalFines)`
- `notifyPaymentConfirmation($db, $userEmail, $amount, $paymentMethod)`

### File: `backend/api/lib/notification_helpers.php`

User notification functions:
- `notifyBorrowRequestApproved($db, $userEmail, $message)`
- `notifyReservedBookAvailable($db, $userEmail, $message)`
- `notifyAdditionRequestApproved($db, $userEmail, $message)`

## Integration Points

### APIs Updated with Notifications:
1. ✅ `backend/api/borrow/request_borrow.php` - Notifies librarians
2. ✅ `backend/api/borrow/request_return.php` - Notifies librarians
3. ✅ `backend/api/payments/process_payment.php` - Notifies user
4. ✅ `backend/api/librarian/approve_borrow_request.php` - Checks fine limits

### APIs That Should Add Notifications (Future):
- Book addition APIs → Call `notifyLibrarianBookAdded()`
- Inventory management APIs → Call `notifyLibrarianInventoryUpdate()`
- Report generation APIs → Call `notifyLibrarianReportGenerated()`

## Fine Limit Enforcement

**Limit**: 200 TK unpaid fines

**Enforcement Points**:
1. ✅ Borrow request approval - rejected if fines >= 200 TK
2. ✅ Daily check at 6 AM - notification sent
3. ✅ Borrow request submission - can still submit but will be rejected at approval

**User Flow**:
1. User accumulates fines
2. At 200 TK threshold → receives `FineLimitReached` notification
3. Cannot borrow more books until fines paid
4. After payment → receives `PaymentConfirmation`
5. Can resume borrowing

## Testing

### Manual Testing:
```bash
# Test borrow request notification
curl -X POST http://localhost:8000/api/borrow/request_borrow.php \
  -H "Content-Type: application/json" \
  -d '{"user_email":"test@nstu.edu.bd","isbn":"978-0-123456-78-9"}'

# Test return request notification
curl -X POST http://localhost:8000/api/borrow/request_return.php \
  -H "Content-Type: application/json" \
  -d '{"user_email":"test@nstu.edu.bd","transaction_id":1}'

# Check notifications
curl http://localhost:8000/api/auth/get_notifications.php?email=librarian@nstu.edu.bd
```

### Event Testing:
```sql
-- Manually trigger events
CALL send_due_date_today_reminders();
CALL check_reservation_expiry();
CALL check_fine_limits();

-- Check event status
SHOW EVENTS FROM iit_shelf;
```

## Status Summary

✅ **Implemented (16/16 notifications)**:
- 8 Student/Teacher/Director notifications
- 6 Librarian notifications
- 2 System notifications

✅ **Automated (7 MySQL events)**:
- Due date reminders (2 days before)
- Due date today reminders
- Fine reminders (every 3 days)
- Reservation expiry checks (every 6 hours)
- Fine limit checks (daily)
- Cleanup expired requests (hourly)
- Cleanup old notifications (monthly)

✅ **Enforcements**:
- Fine limit (200 TK) blocking borrow requests
- Reservation expiry with missed notifications
- Payment confirmations with amount tracking

## Next Steps (Optional Enhancements)

1. Add push notifications for mobile app
2. Email integration for critical notifications
3. SMS notifications for urgent alerts
4. Notification preferences (user can customize)
5. Notification history export
6. Analytics dashboard for notification patterns
